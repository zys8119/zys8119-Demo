<!doctype html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="./vconsole.min.js"></script>
    <script src="./pako.es5.min.js"></script>
    <script>
        new VConsole()
    </script>

    <title>pdf文档解析</title>
</head>
<body>
<script>

    const trailerParse = (data)=>{
        const trailer  = data.split(/trailer/)[1] || ''
        const results = {}
        ;(trailer.match(/\/[^\/]+/g)||[]).forEach(e=>{
            const arr = e.match(/(\/[^\s]+)(.*)/) || []
            let value = arr[2].trim()
            if(/\/id/i.test(arr[1])){
                value = (value.match(/<.*?>/g) || []).map(ee=>ee.replace(/^<|>$/g,''))
            }
            results[arr[1].replace(/^\//,'')] = value
        })
        return results
    }
    const tagsParse = (str)=>{
        const results = {}
        const arr = str.match(/\/[^\/]+/g) || []
        arr.forEach(e=>{
            const arr = (e.match(/\/([^\s]+)(.*)/) || []).map(e=> (e || '').trim().replace(/<<|>>/g,''))
            results[arr[1]] = arr[2]
        })

        return results
    }
    const objectsParse = (data)=>{
        const result = {}
        const objects = data.match(/\d+ \d+ obj?(.|\s)*?endobj/g) || []
        objects.forEach(str=>{
            const key = str.match(/^\d+ \d+ obj/)
            const arr = str.split(/\r/)
            const catalog = tagsParse(arr[1])
            result[key] = {
                str,
                key,
                arr,
                catalog,
                stream:(str.match(/stream\r\n((.|\n|\s)+)\r\nendstream/) || [])[1]
            }
        })
        return result
    }
    const catalogParseKey = (str, isObj)=>{
        if(isObj){
            return str.replace(/obj/i, 'R')
        }
        return str.replace(/r/i, 'obj')
    }

    var xhrSync = new XMLHttpRequest();
    xhrSync.responseType = 'arraybuffer'
    xhrSync.open("GET", '2.pdf', true);
    xhrSync.send();
    xhrSync.onload = async ()=>{
        const data = new TextDecoder().decode(xhrSync.response)
        const pdfInfo = {}
        // console.log(data)
        pdfInfo.version = (data.match(/PDF-(.*)/) || [])[1]
        pdfInfo.objects = objectsParse(data)
        pdfInfo.trailer = trailerParse(data)
        pdfInfo.rootInfo = pdfInfo.objects[catalogParseKey(pdfInfo.trailer.Root)]
        pdfInfo.pagesInfo = pdfInfo.objects[catalogParseKey(pdfInfo.rootInfo.catalog.Pages)]
        pdfInfo.pagesCount = pdfInfo.pagesInfo.catalog.Count
        pdfInfo.Kids = pdfInfo.pagesInfo.catalog.Kids.split("R").map(e=>e.replace(/[^\d\s]/g, '').trim()).filter(e=>e).map(e=>catalogParseKey(e + ' R'))
        const page = pdfInfo.objects[pdfInfo.Kids[0]]
        const pageContent = pdfInfo.objects[catalogParseKey(page.catalog.Contents)]
        console.log(pageContent)
        console.log(pako)
        // console.log(pako.inflate(new TextEncoder().encode(pageContent.stream)))
        console.log([...new TextEncoder().encode('x�{�g��]�n"V�')].map(e=>e.toString(16)))

        console.log(pdfInfo)
    }

</script>
</body>
</html>

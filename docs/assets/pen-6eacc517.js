var j=Object.defineProperty;var q=(w,o,a)=>o in w?j(w,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):w[o]=a;var d=(w,o,a)=>(q(w,typeof o!="symbol"?o+"":o,a),a);import{C as F}from"./CanvasInteraction-df4c52b2.js";import{l as G}from"./lodash-7072a007.js";import{f as z,u as H}from"./index-e06c0445.js";import{d as Q,r as x,g as P,s as B,o as N,c as V,n as U,u as S,B as Z,a as tt,k as et,w as st,_ as nt}from"./index-04c26d2f.js";import"./index-dcd56fe8.js";import"./_commonjsHelpers-edff4021.js";const it={class:"pen"},ot=Q({__name:"pen",setup(w){const{x:o,y:a}=z(),{KeyP:M,Space:A}=H(),X=x({}),Y=P(()=>G.get(X.value,"sceneRef",[])),L=P(()=>Y.value.filter(r=>r.isMouseLineIn===!0)),i=x([]),R=x(),b=x(-1),u=10,y=10,D=P(()=>i.value.length>1?new Array(i.value.length-1).fill([]).map((r,n)=>({start:i.value[n],end:i.value[n+1]})):[]),T=x(null),{isOutside:J}=z(T),m=x(!1),k=x({left:"0px",top:"0px"}),K=r=>{r.preventDefault(),r.stopPropagation();const n=i.value.findIndex(f=>{var I;return f.id===((I=Y.value.find(h=>h.isInside()))==null?void 0:I.id)})-1,v=i.value[n];R.value=v,b.value=n,k.value.left=`${o.value+5}px`,k.value.top=`${a.value+5}px`,m.value=!0},O=()=>{i.value.splice(b.value,1),m.value=!1};B(()=>{m.value||(R.value=null,b.value=-1)});const W=async(r,n)=>{if(m.value=!J.value,!r&&!A.value){const v={x:n.center.x,y:n.center.y,id:Date.now()};L.value.length>0?L.value.forEach(f=>{const I=i.value.findIndex(h=>h.id===f.start.id);i.value.splice(I+1,0,v)}):i.value=i.value.concat([v])}},$=async r=>{X.value=r;const{sceneRef:n,ObjectBase:v}=r;class f extends v{constructor(t,s,p,e,g,c){super(s,p,e,g);d(this,"type","rect");d(this,"offsetX",0);d(this,"offsetY",0);this.color=t,this.x1=s,this.y1=p,this.w=e,this.h=g,this.id=c}get x(){return this.x1+this.offsetX}set x(t){this.x1=t-this.offsetX}get y(){return this.y1+this.offsetY}set y(t){this.y1=t-this.offsetY}get position(){return"content"}async draw(t){t.fillStyle=this.color,t.fillRect(this.x,this.y,this.w,this.h)}}class I extends v{constructor(t,s,p,e,g){super();d(this,"type","line");d(this,"startInitInfo",{x:0,y:0});d(this,"endInitInfo",{x:0,y:0});d(this,"isMouseLineIn",!1);this.start=t,this.p1=s,this.p2=p,this.end=e,this.id=g,this.startInitInfo.x=t.x,this.startInitInfo.y=t.y,this.endInitInfo.x=e.x,this.endInitInfo.y=e.y}get startInfo(){return{x:this.start.x+this.start.w*.5,y:this.start.y+this.start.h*.5}}get endInfo(){return{x:this.end.x+this.end.w*.5,y:this.end.y+this.end.h*.5}}get startMoveInfo(){return this.p1.offsetX=this.start.x-this.startInitInfo.x,this.p1.offsetY=this.start.y-this.startInitInfo.y,{x:this.p1.offsetX,y:this.p1.offsetY}}get endMoveInfo(){return this.p2.offsetX=this.end.x-this.endInitInfo.x,this.p2.offsetY=this.end.y-this.endInitInfo.y,{x:this.p2.offsetX,y:this.p2.offsetY}}get p1Info(){return{x:this.p1.x+this.p1.w*.5+this.startMoveInfo.x,y:this.p1.y+this.p1.h*.5+this.startMoveInfo.y}}get p2Info(){return{x:this.p2.x+this.p2.w*.5+this.endMoveInfo.x,y:this.p2.y+this.p2.h*.5+this.endMoveInfo.y}}toJson(){return{id:this.id,start:{type:this.start.type,id:this.start.id,x:this.start.x,y:this.start.y,w:this.start.w,z:this.start.h},end:{type:this.end.type,id:this.end.id,x:this.end.x,y:this.end.y,w:this.end.w,z:this.end.h},p1:{type:this.p1.type,id:this.p1.id,x:this.p1.x,y:this.p1.y,w:this.p1.w,z:this.p1.h},p2:{type:this.p2.type,id:this.p2.id,x:this.p2.x,y:this.p2.y,w:this.p2.w,z:this.p2.h}}}async draw(t){const s=this.startInfo.x,p=this.startInfo.y,e=this.endInfo.x,c=(this.endInfo.y-p)/(e-s),C=Math.round(c*o.value+(p-c*s)),_=1,E=2;t.lineWidth=_,this.isMouseLineIn=a.value-_-E<=C&&C<=a.value+_+E,t.strokeStyle=this.isMouseLineIn?"#f00":"#eee",t.beginPath(),t.moveTo(this.startInfo.x,this.startInfo.y),t.lineTo(this.endInfo.x,this.endInfo.y),t.stroke(),t.strokeStyle=this.isMouseLineIn?"#0080ff":"#000000",t.beginPath(),t.moveTo(this.startInfo.x,this.startInfo.y),t.bezierCurveTo(this.p1Info.x-this.p1.offsetX,this.p1Info.y-this.p1.offsetY,this.p2Info.x-this.p2.offsetX,this.p2Info.y-this.p2.offsetY,this.endInfo.x,this.endInfo.y),t.stroke(),this.isMouseLineIn&&(t.beginPath(),t.fillStyle="#f00",t.arc(o.value,a.value,_+4,0,2*Math.PI),t.fill(),t.beginPath(),t.strokeStyle="#0080ff",t.arc(o.value,a.value,_+4,0,2*Math.PI),t.stroke()),M.value&&(t.strokeStyle="#0080ff",t.beginPath(),t.moveTo(this.startInfo.x,this.startInfo.y),t.lineTo(this.p1Info.x-this.startMoveInfo.x,this.p1Info.y-this.startMoveInfo.y),t.stroke(),t.beginPath(),t.moveTo(this.endInfo.x,this.endInfo.y),t.lineTo(this.p2Info.x-this.endMoveInfo.x,this.p2Info.y-this.endMoveInfo.y),t.stroke())}}st(i,()=>{const h=n.value.filter(t=>t.type==="line").map(t=>t.toJson()).reduce((t,s)=>(t[s.id]=s,t),{});n.value=[],i.value.length===1&&n.value.push(new f("#f00",i.value[0].x,i.value[0].y,u,y));let l=null;D.value.forEach(({start:t,end:s},p)=>{const e=h[t.id];p===0?(l=new I(new f("#f00",(e==null?void 0:e.start.x)||t.x,(e==null?void 0:e.start.y)||t.y,u,y,t.id),new f("#09f",(e==null?void 0:e.p1.x)||t.x,(e==null?void 0:e.p1.y)||t.y,u,y,t.id),new f("#09f",(e==null?void 0:e.p2.x)||s.x,(e==null?void 0:e.p2.y)||s.y,u,y,s.id),new f("#f00",(e==null?void 0:e.end.x)||s.x,(e==null?void 0:e.end.y)||s.y,u,y,s.id),t.id),n.value.push(l.start)):l=new I(l.end,new f("#09f",(e==null?void 0:e.p1.x)||t.x,(e==null?void 0:e.p1.y)||t.y,u,y,t.id),new f("#09f",(e==null?void 0:e.p2.x)||s.x,(e==null?void 0:e.p2.y)||s.y,u,y,s.id),new f("#f00",(e==null?void 0:e.end.x)||s.x,(e==null?void 0:e.end.y)||s.y,u,y,s.id),t.id),n.value.push(l.end),n.value.push(l.p1),n.value.push(l.p2),n.value.push(l)})},{deep:!0}),B(()=>{n.value.filter(h=>h.type==="line").forEach(h=>{h.p1.visible=M.value,h.p2.visible=M.value})})};return(r,n)=>(N(),V("div",it,[U(S(F),{onLoad:$,gap:0,onPenStart:W,onContextmenu:K}),S(m)?(N(),V("div",{key:0,ref_key:"contextmenuRef",ref:T,class:"absolute b-solid b b-#f00 shadow shadow-xl shadow-15px bg-#fff p-10px b-rd-10px cursor-pointer",style:Z(S(k))},[tt("div",{onClick:O},"删除")],4)):et("",!0)]))}});const yt=nt(ot,[["__scopeId","data-v-37f15f3f"]]);export{yt as default};

import{_ as W}from"./beta-webm-1fc2fde4.js";import{d as q,r,g as G,s as J,B as K,h as Q,o as l,c as d,a as e,F as X,b as Y,C as Z,y as D,n as k,u as n,t as w,k as v,q as S,E as ee,G as m,D as te,l as F,j as oe,p as se,e as ae,_ as ne}from"./index-71ff745c.js";import{a as N}from"./axios-4a70c6fc.js";import{l as B}from"./lodash-d2667470.js";import{R as L}from"./mp3-engine-4f57b2c7.js";import{S as C}from"./svg-icon-4f457caa.js";import{H as le}from"./hammer-fc5ab476.js";import{_ as ie}from"./Button-03cf1ab5.js";import{_ as ce}from"./Input-84b718ca.js";import"./index-710fd454.js";import"./_commonjsHelpers-87174ba5.js";import"./format-length-c9d165c6.js";import"./index-714b5119.js";const V=h=>(se("data-v-f00ee3f4"),h=h(),ae(),h),de={class:"ai-voice bg-#e8e8e8 abs-content of-x-hidden"},re={class:"p-15px"},pe=["onClick"],ue={key:0,class:"flex flex-col items-start"},fe={class:"flex-center gap-10px"},ve=["id","src"],_e={key:0,class:"w-100% b-t-solid b-1px b-#fff m-t-10px"},xe={key:1},me={key:2},he=V(()=>e("div",{style:{color:"#ffffff"},class:"la-ball-spin-clockwise-fade-rotating la-sm"},[e("div"),e("div"),e("div"),e("div"),e("div"),e("div"),e("div"),e("div")],-1)),ye=[he],be={class:"w-30px h-30px bg-$color flex text-12px b-rd-50% of-hidden flex-center text-#fff"},ge={class:"p-x-15px flex items-center gap-10px"},ke=["onClick"],we={class:"flex-center gap-10px"},Se={key:0,class:"abs-center bg-#38b06d p-15px b-rd-10px flex-center flex-col"},Ce=V(()=>e("div",{class:"la-line-scale"},[e("div"),e("div"),e("div"),e("div"),e("div")],-1)),Re=V(()=>e("div",{class:"text-12px text-#fff"},"松开发送",-1)),Ue=[Ce,Re],Be=q({__name:"ai-voice",setup(h){const R=r(),p=r(!0),y=r(!1),i=r(!1),u=r(""),z=G(()=>u.value.length===0||i.value),f=r([]),A=()=>{i.value=!1,f.value.pop()},I=r("http://192.168.110.46:8000"),E=B.debounce(async()=>{const o=u.value;f.value.push({content:o,type:"text",isSelf:!0}),f.value.push({type:"loading",isSelf:!1}),u.value="";try{i.value=!0;const{data:t}=await N({method:"post",baseURL:I.value,url:"/v1/chat/completions",data:{model:"chatglm3-6b",messages:[{content:o,role:"user"}]}});i.value&&(f.value.pop(),B.get(t,"choices",[]).forEach(s=>{f.value.push({content:B.get(s,"message.content"),type:"text",isSelf:!1})})),i.value=!1}catch{i.value=!1}},300),O=async o=>{try{i.value=!0;const t=new FormData;t.append("model","large-v3");const s=new File([o.blob],"audio.mp3",{type:"audio/mp3"});t.append("file",s),o.url=URL.createObjectURL(s),f.value.push(o);const{data:x}=await N({method:"post",baseURL:I.value,url:"/v1/audio/transcriptions",data:t});i.value&&(u.value=x.text,await E()),i.value=!1}catch(t){console.error(t),i.value=!1}};let c,b;const H=o=>{c=L({type:"mp3",sampleRate:16e3,bitRate:16,onProcess:function(t,s,x,U,a,g){b&&b.input(t[t.length-1],s,U)}}),c.open(function(){L.WaveView&&(b=L.WaveView({elem:".recwave"})),o&&(o==null||o())},function(t,s){console.log((s?"UserNotAllow，":"")+"无法录音:"+t)})};function M(){c.start()}function P(){c.stop(async function(o,t){var s=(window.URL||webkitURL).createObjectURL(o);O({url:s,time:t,blob:o,type:"audio",isSelf:!0})},function(o){alert(o),console.log("录音失败:"+o)})}const T=async o=>{var t,s;(s=(t=document.getElementById(o))==null?void 0:t.play)==null||s.call(t)},_=r(),$=async()=>{R.value&&(_.value&&_.value.destroy(),_.value=new le(R.value),_.value.on("press",()=>{y.value=!0,M()}),_.value.on("pressup",()=>{y.value=!1,P()}))},j=async()=>{await ee(),H(()=>{}),$()};return J(()=>{!c&&p.value?j():p.value&&$()}),K(()=>{var o;(o=c==null?void 0:c.close)==null||o.call(c),c=null,b=null,y.value=!1}),Q(async()=>{j()}),(o,t)=>{const s=ie,x=ce,U=W;return l(),d("div",de,[e("div",re,[(l(!0),d(X,null,Y(n(f),(a,g)=>(l(),d("div",{key:g,style:Z({"--color":a.isSelf?"#3ab370":"cadetblue"})},[e("div",{class:D(["m-b-10px flex items-center gap-10px justify-end flex-shrink-0",{"flex-row-reverse":!a.isSelf}])},[e("div",{class:D(["flex-1 flex justify-end",{"flex-row-reverse":!a.isSelf}])},[e("div",{class:"bg-$color b-rd-10px p-10px b-1px b-solid b-#fff text-#fff",onClick:Le=>T(`audio${g}`)},[a.type==="audio"?(l(),d("div",ue,[e("div",fe,[k(n(C),{name:"yuyin"}),e("audio",{controls:"",ref_for:!0,ref:"audio",id:`audio${g}`,hidden:"",src:a.url},null,8,ve),e("div",null,w((a.time/1e3).toFixed(1))+"s",1)]),a.content?(l(),d("div",_e,w(a.content),1)):v("",!0)])):v("",!0),a.type==="text"?(l(),d("div",xe,[e("div",null,w(a.content),1)])):v("",!0),a.type==="loading"?(l(),d("div",me,ye)):v("",!0)],8,pe)],2),e("div",be,w(a.isSelf?"我":"对方"),1)],2)],4))),128))]),k(U,null,{default:S(()=>[e("div",ge,[e("div",{onClick:t[0]||(t[0]=a=>p.value=!n(p)),class:"w-30px h-30px flex-center b-1px b-solid b-#38b06d text-#38b06d b-rd-50% text-18px flex-shrink-0"},[n(p)?(l(),m(n(C),{key:0,name:"jianpan"})):(l(),m(n(C),{key:1,name:"yuyin"}))]),n(p)?(l(),d("div",{key:0,ref_key:"voiceBtnRef",ref:R,class:"flex-1 touch-callout select-none",onClick:te(a=>{},["stop","prevent"])},[k(s,{class:"flex-1 w-100% select-none",disabled:n(i)},{default:S(()=>[F("按住说话")]),_:1},8,["disabled"])],8,ke)):(l(),m(x,{key:1,class:"flex-1",clearable:"",type:"textarea",autosize:"",value:n(u),"onUpdate:value":t[1]||(t[1]=a=>oe(u)?u.value=a:null),placeholder:"请输入"},null,8,["value"])),e("div",we,[!n(p)&&!n(i)?(l(),m(s,{key:0,type:"primary",onClick:n(E),disabled:n(z)},{default:S(()=>[F("发送")]),_:1},8,["onClick","disabled"])):v("",!0),n(i)?(l(),m(s,{key:1,class:"text-28px",type:"default",onClick:A},{default:S(()=>[k(n(C),{name:"stop"})]),_:1})):v("",!0)])])]),_:1}),n(y)?(l(),d("div",Se,Ue)):v("",!0)])}}});const Pe=ne(Be,[["__scopeId","data-v-f00ee3f4"]]);export{Pe as default};

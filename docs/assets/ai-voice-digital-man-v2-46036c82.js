import{_ as ge}from"./beta-webm-1fc2fde4.js";import{d as ke,r as c,g as Re,s as Ce,B as Le,h as Ue,o as r,c as m,a as t,F as Ie,b as Ve,C as Ee,y as re,n as C,u as l,t as S,k as x,q as T,D as de,E as ze,G as L,l as ue,j as De,p as Be,e as je,_ as Fe}from"./index-71ff745c.js";import{t as Se,q as Te,m as Pe}from"./ai-b-cf3f840e.js";import{m as fe,p as Ae}from"./pinyin-web-87845f0c.js";import{a as q}from"./axios-4a70c6fc.js";import{l as g}from"./lodash-d2667470.js";import{R as G}from"./mp3-engine-4f57b2c7.js";import{S as U}from"./svg-icon-4f457caa.js";import{H as Me}from"./hammer-fc5ab476.js";import{b as Ne}from"./index-710fd454.js";import{_ as $e}from"./Input-84b718ca.js";import{_ as He}from"./Button-03cf1ab5.js";import"./_commonjsHelpers-87174ba5.js";import"./format-length-c9d165c6.js";import"./index-714b5119.js";const y=I=>(Be("data-v-f0d884e4"),I=I(),je(),I),Oe={class:"ai-voice bg-#e8e8e8 abs-content of-x-hidden"},We={class:"p-15px"},qe=["onClick"],Ge={key:0,class:"flex flex-col items-start"},Ye={class:"flex-center gap-10px"},Je=["id","src"],Ke={key:0,class:"w-100% b-t-solid b-1px b-#fff m-t-10px"},Qe={key:1},Xe={key:2},Ze=y(()=>t("div",{style:{color:"#ffffff"},class:"la-ball-spin-clockwise-fade-rotating la-sm"},[t("div"),t("div"),t("div"),t("div"),t("div"),t("div"),t("div"),t("div")],-1)),et=[Ze],tt={class:"w-30px h-30px bg-$color flex text-12px b-rd-50% of-hidden flex-center text-#fff"},at={class:"p-x-15px flex items-center gap-10px"},st=["onClick"],ot={class:"flex-center gap-10px"},nt={key:0,class:"abs-center bg-#38b06d p-15px b-rd-10px flex-center flex-col"},lt=y(()=>t("div",{class:"la-line-scale"},[t("div"),t("div"),t("div"),t("div"),t("div")],-1)),it=y(()=>t("div",{class:"text-12px text-#fff"},"松开发送",-1)),ct=[lt,it],rt=["src"],dt=y(()=>t("div",{class:"text-14px"},"打招呼",-1)),ut={key:0,class:"abs-center p-15px b-rd-10px flex-center flex-col"},ft=y(()=>t("div",{class:"la-line-scale"},[t("div"),t("div"),t("div"),t("div"),t("div")],-1)),pt=y(()=>t("div",{class:"text-12px text-#fff"},"模型正在加载中，请耐心等待...",-1)),vt=[ft,pt],mt={key:1,class:"abs-end p-15px b-rd-10px flex-center flex-col"},_t=y(()=>t("div",{class:"la-line-scale"},[t("div"),t("div"),t("div"),t("div"),t("div")],-1)),xt=y(()=>t("div",{class:"text-12px text-#fff"},"正在聆听者...",-1)),yt=[_t,xt],ht=ke({__name:"ai-voice-digital-man-v2",setup(I){const{toggle:Y}=Ne(),P=c(),h=c(!0),V=c(!1),d=c(!1),k=c(!1),J=c(),w=c(""),pe=Re(()=>w.value.length===0||d.value),b=c([]),u=c(),f=c(),ve=()=>{d.value=!1,b.value.pop()},A=c(null),K=g.debounce(async()=>{const s=w.value;b.value.push({content:s,type:"text",isSelf:!0}),b.value.push({type:"loading",isSelf:!1}),w.value="";try{d.value=!0;const{data:e}=await q({method:"post",baseURL:A.value,url:"/v1/chat/completions",data:{model:"chatglm3-6b",messages:[{content:"你是智加信息科技有限公司的AI助手！",role:"system"},{content:s,role:"user"}]}});d.value&&(b.value.pop(),await Promise.all(g.get(e,"choices",[]).forEach(async a=>{b.value.push({content:g.get(a,"message.content"),type:"text",isSelf:!1}),await H(g.get(a,"message.content"),async i=>{var o,p;let n=i<10?i:10;for(;n>0;)await((o=u.value)==null?void 0:o.call(u,1,1+n,n)),i-=10,n=i<10?i:10;await((p=f.value)==null?void 0:p.call(f,2.9,null,0))})}))),d.value=!1}catch{d.value=!1}},300),me=async s=>{try{d.value=!0;const e=new FormData;e.append("model","large-v3");const a=new File([s.blob],"audio.mp3",{type:"audio/mp3"});e.append("file",a),s.url=URL.createObjectURL(a),b.value.push(s);const{data:i}=await q({method:"post",baseURL:A.value,url:"/v1/audio/transcriptions",data:e});console.clear();const n=Ae(i.text,{style:"NORMAL"}).map(p=>p[0]).join("");console.log(i.text,n);const o=/xiao(zhi|zi)/;d.value&&o.test(n)&&(w.value=i.text.substring(2),await K()),d.value=!1}catch(e){console.error(e),d.value=!1}};let v,E,Q=performance.now(),z=!1,M=!1;const _e=s=>{v=G({type:"mp3",sampleRate:16e3,bitRate:16,onProcess:async function(e,a,i,n,o,p){E&&E.input(e[e.length-1],a,n),M||(!z&&Math.max.apply(null,e.at(-1))>1e3?(Q=performance.now(),z=!0):z&&performance.now()-Q>3e3&&(M=!0,await X(),await N(),M=!1,z=!1))}}),v.open(async function(){N(),G.WaveView&&(E=G.WaveView({elem:".recwave"})),s&&(s==null||s())},function(e,a){console.log((a?"UserNotAllow，":"")+"无法录音:"+e)})};async function N(){v.start()}async function X(){return new Promise(s=>{v.stop(async function(e,a){var i=(window.URL||webkitURL).createObjectURL(e);await me({url:i,time:a,blob:e,type:"audio",isSelf:!0}),s()},function(e){alert(e),console.log("录音失败:"+e),s()})})}const xe=async s=>{var e,a;(a=(e=document.getElementById(s))==null?void 0:e.play)==null||a.call(e)},R=c(),Z=async()=>{P.value&&(R.value&&R.value.destroy(),R.value=new Me(P.value),R.value.on("press",()=>{V.value=!0,N()}),R.value.on("pressup",()=>{V.value=!1,X()}))},ee=async()=>{await ze(),_e(()=>{}),Z()};Ce(()=>{!v&&h.value?ee():h.value&&Z()}),Le(()=>{var s;(s=v==null?void 0:v.close)==null||s.call(v),v=null,E=null,V.value=!1});const ye=Se({similarity:.4,smoothness:.05,spill:.05}),te=async(s,e,a)=>{const{clip:i,mp4Info:n}=a;async function o(p=0,j,he){const we=Number((n.duration/n.timescale).toFixed(0));typeof j!="number"&&(j=we);const le=j-p,be=(he||le)*1e3,ie=async W=>{const F=await i.getVideoFrame(p+le*W);if(F){e.clearRect(0,0,e.canvas.width,e.canvas.height);const _=await ye(F);e.drawImage(_,0,0,_.codedWidth,_.codedHeight,(e.canvas.width-_.codedWidth)/2,e.canvas.height-_.codedHeight,_.codedWidth,_.codedHeight)}};return new Promise(W=>{const F=performance.now();(async function _(){const ce=(performance.now()-F)/be;if(ce>1){await ie(1),W();return}await ie(ce),requestAnimationFrame(_)})()})}return o},$=c([]),D=c(!1),H=async(s,e)=>{D.value=!0,$.value.forEach(n=>{n.pause(),n.remove()}),$.value=[];const a=document.createElement("audio");$.value.push(a),a.autoplay=!0,a.addEventListener("loadedmetadata",async()=>{var n;e?await e(a.duration,a):await((n=u.value)==null?void 0:n.call(u,null,null,a.duration))}),a.addEventListener("ended",()=>{D.value=!1});const{data:i}=await q({baseURL:A.value,method:"post",url:"/v1/audio/speech",responseType:"blob",data:{input:s,voice:"3559"}});a.src=URL.createObjectURL(i)},ae=c(!1),O=g.debounce(async()=>{await H("大家好；我是智加小智；很高兴与大家见面；大家可以叫我小智来与我对话；比如，小智介绍自己。",async s=>{var e,a;await((e=u.value)==null?void 0:e.call(u,12,17,s)),ae.value?await((a=f.value)==null?void 0:a.call(f,2.9,null,0)):await H("与此同时小智在此提前祝大家新年快乐",async i=>{var n,o;await((n=u.value)==null?void 0:n.call(u,18,21,i)),await((o=f.value)==null?void 0:o.call(f,2.9,null,0)),ae.value=!0})})},300),se=async s=>{const e=await fetch(s||fe),a=new Te(e.body),i=await a.ready,n=await a.getInfo();return{clip:a,mp4Info:n,body:i}},B={},oe=g.debounce(async(s,e)=>{var a;s.width=window.innerWidth*window.devicePixelRatio,s.height=window.innerHeight*window.devicePixelRatio,f.value=await te(s,e,B.videoSpeech2),u.value=await te(s,e,B.videoSpeech),await((a=f.value)==null?void 0:a.call(f,2.9,null,0))},300),ne=c(performance.now());return Ue(async()=>{k.value=!0,B.videoSpeech2=await se(Pe),B.videoSpeech=await se(fe),ee();const s=J.value,e=s.getContext("2d");oe(s,e),window.addEventListener("resize",()=>{oe(s,e)}),k.value=!1,setInterval(()=>{!k.value&&performance.now()>ne.value+5e3&&!D.value&&(O(),ne.value=performance.now()+5e3)},1e4)}),(s,e)=>{const a=He,i=$e,n=ge;return r(),m("div",Oe,[t("div",We,[(r(!0),m(Ie,null,Ve(l(b),(o,p)=>(r(),m("div",{key:p,style:Ee({"--color":o.isSelf?"#3ab370":"cadetblue"})},[t("div",{class:re(["m-b-10px flex items-center gap-10px justify-end flex-shrink-0",{"flex-row-reverse":!o.isSelf}])},[t("div",{class:re(["flex-1 flex justify-end",{"flex-row-reverse":!o.isSelf}])},[t("div",{class:"bg-$color b-rd-10px p-10px b-1px b-solid b-#fff text-#fff",onClick:j=>xe(`audio${p}`)},[o.type==="audio"?(r(),m("div",Ge,[t("div",Ye,[C(l(U),{name:"yuyin"}),t("audio",{controls:"",ref_for:!0,ref:"audio",id:`audio${p}`,hidden:"",src:o.url},null,8,Je),t("div",null,S((o.time/1e3).toFixed(1))+"s",1)]),o.content?(r(),m("div",Ke,S(o.content),1)):x("",!0)])):x("",!0),o.type==="text"?(r(),m("div",Qe,[t("div",null,S(o.content),1)])):x("",!0),o.type==="loading"?(r(),m("div",Xe,et)):x("",!0)],8,qe)],2),t("div",tt,S(o.isSelf?"我":"对方"),1)],2)],4))),128))]),C(n,null,{default:T(()=>[t("div",at,[t("div",{onClick:e[0]||(e[0]=o=>h.value=!l(h)),class:"w-30px h-30px flex-center b-1px b-solid b-#38b06d text-#38b06d b-rd-50% text-18px flex-shrink-0"},[l(h)?(r(),L(l(U),{key:0,name:"jianpan"})):(r(),L(l(U),{key:1,name:"yuyin"}))]),l(h)?(r(),m("div",{key:0,ref_key:"voiceBtnRef",ref:P,class:"flex-1 touch-callout select-none",onClick:de(o=>{},["stop","prevent"])},[C(a,{class:"flex-1 w-100% select-none",disabled:l(d)},{default:T(()=>[ue("按住说话")]),_:1},8,["disabled"])],8,st)):(r(),L(i,{key:1,class:"flex-1",clearable:"",type:"textarea",autosize:"",value:l(w),"onUpdate:value":e[1]||(e[1]=o=>De(w)?w.value=o:null),placeholder:"请输入"},null,8,["value"])),t("div",ot,[!l(h)&&!l(d)?(r(),L(a,{key:0,type:"primary",onClick:l(K),disabled:l(pe)},{default:T(()=>[ue("发送")]),_:1},8,["onClick","disabled"])):x("",!0),l(d)?(r(),L(a,{key:1,class:"text-28px",type:"default",onClick:ve},{default:T(()=>[C(l(U),{name:"stop"})]),_:1})):x("",!0)])])]),_:1}),l(V)?(r(),m("div",nt,ct)):x("",!0),t("div",{class:"abs-content z-1",onClick:e[3]||(e[3]=(...o)=>l(Y)&&l(Y)(...o))},[t("img",{class:"abs-content",src:"./ai-bg2.jpeg",alt:""},null,8,rt),t("canvas",{class:"abs-content",ref_key:"convasRef",ref:J,style:{transform:"scale(1.5) translateY(-15%)"}},null,512),t("div",{class:"abs-end-bottom rigth-30px bottom-30px flex-center flex-col bg-#fff5 p-15px b-rd-y-10px cursor-pointer text-50px",onClick:e[2]||(e[2]=de((...o)=>l(O)&&l(O)(...o),["stop"]))},[C(l(U),{name:"dazhaohu","not-fill":""}),dt]),l(k)?(r(),m("div",ut,vt)):x("",!0),!l(k)&&!l(D)?(r(),m("div",mt,yt)):x("",!0)])])}}});const Ft=Fe(ht,[["__scopeId","data-v-f0d884e4"]]);export{Ft as default};
